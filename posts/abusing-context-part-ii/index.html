<!DOCTYPE html>
<html lang="en" itemscope itemtype="http://schema.org/WebPage">
  <head>
    

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

  <title>Abusing Context Part II: Recovery - raidancampbell</title>
  <meta name="description" content="While not required, it&rsquo;s highly recommended that you read Dave Cheney&rsquo;s post on Dynamically Scoped Variables before continuing.
What and Why?  Consider an instance of context.Context as it flows through the code. Typically it&rsquo;s created at the beginning of a transaction and enriched or referenced throughout the transaction. Sometimes it&rsquo;s not passed everywhere &ndash; it certainly doesn&rsquo;t need to be. Consider a scenario where you have an encryption library and it contains a simple function AESEncrypt:">
  <meta name="author" content="R. Aidan Campbell"/><script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "WebSite",
    "name": "raidancampbell",
    
    "url": "https:\/\/raidancampbell.com\/"
}
</script><script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Organization",
  "name": "",
  "url": "https:\/\/raidancampbell.com\/"
  
  
  
  
}
</script>
<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [{
        "@type": "ListItem",
        "position": 1,
        "item": {
          "@id": "https:\/\/raidancampbell.com\/",
          "name": "home"
        }
    },{
        "@type": "ListItem",
        "position": 3,
        "item": {
          "@id": "https:\/\/raidancampbell.com\/posts\/abusing-context-part-ii\/",
          "name": "Abusing context part i i recovery"
        }
    }]
}
</script><script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Article",
  "author": {
    "name" : "R. Aidan Campbell"
  },
  "headline": "Abusing Context Part II: Recovery",
  "description" : "While not required, it\x26rsquo;s highly recommended that you read Dave Cheney\x26rsquo;s post on Dynamically Scoped Variables before continuing.\nWhat and Why?  Consider an instance of context.Context as it flows through the code. Typically it\x26rsquo;s created at the beginning of a transaction and enriched or referenced throughout the transaction. Sometimes it\x26rsquo;s not passed everywhere \x26ndash; it certainly doesn\x26rsquo;t need to be. Consider a scenario where you have an encryption library and it contains a simple function AESEncrypt:",
  "inLanguage" : "en",
  "wordCount":  1989 ,
  "datePublished" : "2020-06-04T16:31:47",
  "dateModified" : "2020-06-04T16:31:47",
  "image" : "https:\/\/raidancampbell.com\/",
  "keywords" : [ "" ],
  "mainEntityOfPage" : "https:\/\/raidancampbell.com\/posts\/abusing-context-part-ii\/",
  "publisher" : {
    "@type": "Organization",
    "name" : "https:\/\/raidancampbell.com\/",
    "logo" : {
        "@type" : "ImageObject",
        "url" : "https:\/\/raidancampbell.com\/",
        "height" :  60 ,
        "width" :  60
    }
  }
}
</script>

<meta property="og:title" content="Abusing Context Part II: Recovery" />
<meta property="og:description" content="While not required, it&rsquo;s highly recommended that you read Dave Cheney&rsquo;s post on Dynamically Scoped Variables before continuing.
What and Why?  Consider an instance of context.Context as it flows through the code. Typically it&rsquo;s created at the beginning of a transaction and enriched or referenced throughout the transaction. Sometimes it&rsquo;s not passed everywhere &ndash; it certainly doesn&rsquo;t need to be. Consider a scenario where you have an encryption library and it contains a simple function AESEncrypt:">
<meta property="og:url" content="https://raidancampbell.com/posts/abusing-context-part-ii/" />
<meta property="og:type" content="website" />
<meta property="og:site_name" content="raidancampbell" />

  <meta name="twitter:title" content="Abusing Context Part II: Recovery" />
  <meta name="twitter:description" content="While not required, it&rsquo;s highly recommended that you read Dave Cheney&rsquo;s post on Dynamically Scoped Variables before continuing.
What and Why?  Consider an instance of context.Context as it â€¦">
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:site" content="@@raidancampbell" />
  <meta name="twitter:creator" content="@@raidancampbell" />
  <meta name="generator" content="Hugo 0.71.0" />
  <link rel="alternate" href="https://raidancampbell.com/index.xml" type="application/rss+xml" title="raidancampbell"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css" integrity="sha384-9eLZqc9ds8eNjO3TmqPeYcDj8n+Qfa4nuSiGYa6DjLNcv9BtN69ZIulL9+8CqC9Y" crossorigin="anonymous">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css" integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU" crossorigin="anonymous">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous"><link rel="stylesheet" href="https://raidancampbell.com/css/main.css" /><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" /><link rel="stylesheet" href="https://raidancampbell.com/css/syntax.css" /><link rel="stylesheet" href="https://raidancampbell.com/css/codeblock.css" /><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.css" integrity="sha384-h/L2W9KefUClHWaty3SLE5F/qvc4djlyR4qY3NUV5HGQBBW7stbcfff1+I/vmsHh" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/default-skin/default-skin.min.css" integrity="sha384-iD0dNku6PYSIQLyfTOpB06F2KCZJAKLOThS5HRe8b3ibhdEQ6eKsFf/EeFxdOt5R" crossorigin="anonymous">


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-62271915-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>


  </head>
  <body>
    <nav class="navbar navbar-default navbar-fixed-top navbar-custom">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#main-navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="https://raidancampbell.com/">raidancampbell</a>
    </div>

    <div class="collapse navbar-collapse" id="main-navbar">
      <ul class="nav navbar-nav navbar-right">
        
          
            <li>
              <a title="Blog" href="/">Blog</a>
            </li>
          
        

        

        
      </ul>
    </div>

    

  </div>
</nav>




    


<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>


  
  
  






  

  <header class="header-section ">
    
    <div class="intro-header no-img">
      <div class="container">
        <div class="row">
          <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
            <div class="posts-heading">
              
                <h1>Abusing Context Part II: Recovery</h1>
              
              
                <hr class="small">
              
              
              
            </div>
          </div>
        </div>
      </div>
    </div>
  </header>


    
<div class="container" role="main">
  <div class="row">
    <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
      <article role="main" class="blog-post">
        <p>While not required, it&rsquo;s highly recommended that you read Dave Cheney&rsquo;s post on <a href="https://dave.cheney.net/2019/12/08/dynamically-scoped-variables-in-go">Dynamically Scoped Variables</a> before continuing.</p>
<h2 id="what-and-why">What and Why?</h2>
<hr>
<p>Consider an instance of <a href="https://golang.org/pkg/context/"><code>context.Context</code></a> as it flows through the code.
Typically it&rsquo;s created at the beginning of a transaction and enriched or referenced throughout the transaction.
Sometimes it&rsquo;s not passed everywhere &ndash; it certainly doesn&rsquo;t need to be.
Consider a scenario where you have an encryption library and it contains a simple function <code>AESEncrypt</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">crypto</span>
<span style="color:#f92672">import</span> (
<span style="color:#e6db74">&#34;crypto/aes&#34;</span>
<span style="color:#e6db74">&#34;crypto/cipher&#34;</span>
<span style="color:#e6db74">&#34;crypto/rand&#34;</span>
<span style="color:#e6db74">&#34;github.com/spf13/viper&#34;</span>
<span style="color:#e6db74">&#34;io&#34;</span>
)
<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">AESEncrypt</span>(<span style="color:#a6e22e">keyID</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">plaintext</span> []<span style="color:#66d9ef">byte</span>) (<span style="color:#a6e22e">ciphertext</span>, <span style="color:#a6e22e">nonce</span> []<span style="color:#66d9ef">byte</span>, <span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>) {

    <span style="color:#a6e22e">key</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">viper</span>.<span style="color:#a6e22e">GetString</span>(<span style="color:#a6e22e">keyID</span>) <span style="color:#75715e">// retrieve the key from config file
</span><span style="color:#75715e"></span>      
    <span style="color:#a6e22e">block</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">aes</span>.<span style="color:#a6e22e">NewCipher</span>([]byte(<span style="color:#a6e22e">key</span>))
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
      <span style="color:#66d9ef">return</span>  <span style="color:#75715e">// key was malformed?
</span><span style="color:#75715e"></span>    }
  
    <span style="color:#a6e22e">nonce</span> = make([]<span style="color:#66d9ef">byte</span>, <span style="color:#ae81ff">12</span>)
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">ReadFull</span>(<span style="color:#a6e22e">rand</span>.<span style="color:#a6e22e">Reader</span>, <span style="color:#a6e22e">nonce</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
      panic(<span style="color:#a6e22e">err</span>.<span style="color:#a6e22e">Error</span>()) <span style="color:#75715e">// if you can&#39;t read your random, you&#39;ve got problems
</span><span style="color:#75715e"></span>    }
   
    <span style="color:#a6e22e">aesgcm</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">cipher</span>.<span style="color:#a6e22e">NewGCM</span>(<span style="color:#a6e22e">block</span>)
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
      panic(<span style="color:#a6e22e">err</span>.<span style="color:#a6e22e">Error</span>()) <span style="color:#75715e">// inputs are effectively static
</span><span style="color:#75715e"></span>    }
   
    <span style="color:#a6e22e">ciphertext</span> = <span style="color:#a6e22e">aesgcm</span>.<span style="color:#a6e22e">Seal</span>(<span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">nonce</span>, <span style="color:#a6e22e">plaintext</span>, <span style="color:#66d9ef">nil</span>)
    <span style="color:#66d9ef">return</span>
}
</code></pre></div><p>The function reads in an encryption key, builds a cipher, and encrypts the input.
It works faithfully for a few months, until someone decides keys need to be stored on a keyserver and retrieved at runtime.
Now the earlier call</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#a6e22e">viper</span>.<span style="color:#a6e22e">GetString</span>(<span style="color:#a6e22e">keyID</span>) <span style="color:#75715e">// retrieve the key from config file
</span></code></pre></div><p>must change to</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#a6e22e">key</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">keyserverClient</span>.<span style="color:#a6e22e">GetKey</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">TODO</span>(), <span style="color:#a6e22e">keyID</span>) <span style="color:#75715e">// retrieve the key from the keyserver
</span></code></pre></div><p>and now we have no context to provide.
In a perfect world, we&rsquo;d refactor the <code>AESEncrypt</code> to change the function signature to add context support.
But I&rsquo;m lazy and want a different approach.</p>
<p>We had the context further up the callstack, but it was omitted at some point in the stack.  We want it back now.</p>
<h2 id="how">How?</h2>
<hr>
<h3 id="the-limitations">The Limitations</h3>
<p>To begin this journey, let&rsquo;s note some of the restrictions placed on <code>contex.Context</code>.
Each restriction limits the work we have to do: narrower scope means less scenarios to handle.</p>
<ul>
<li>A context SHOULD be the first parameter in the function signature. The <code>go lint</code> linter <code>lintContextArgs</code> <a href="https://github.com/golang/lint/blob/master/lint.go#L1413">checks for this</a></li>
<li>Context is an interface which contains four unexported implementations under the hood: <a href="https://golang.org/src/context/context.go#L427">deadline</a>, <a href="https://golang.org/src/context/context.go#L232">cancel</a>, <a href="https://golang.org/src/context/context.go#L513">value</a>, and <a href="https://golang.org/src/context/context.go#L171">empty</a>.</li>
</ul>
<p>So we always know where a context will be in a function signature and also the legal values of its underlying concrete type.
The next tools for solving the problem come from understanding the internals of go.  Specifically, the <code>interface</code></p>
<p>Interfaces, such as the <code>context.Context</code> interface, are constructed by two parts: an <code>itab</code> and the data.
The <code>runtime2.go</code> <a href="https://github.com/golang/go/blob/bf86aec25972f3a100c3aa58a6abcbcc35bdea49/src/runtime/runtime2.go#L143-L146">source</a> has it defined simply as:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">iface</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">tab</span>  <span style="color:#f92672">*</span><span style="color:#a6e22e">itab</span>
	<span style="color:#a6e22e">data</span> <span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span>
}
</code></pre></div><p><code>itab</code>, short for &ldquo;itable&rdquo;, short for &ldquo;interface table&rdquo;, contains all the details the go linker and runtime require for <a href="http://en.wikipedia.org/wiki/Duck_typing">ducktyping</a> to work.
A more in-depth view is available at the <a href="https://cmc.gitbook.io/go-internals/chapter-ii-interfaces#anatomy-of-an-interface">go-internals Interfaces</a> chapter.
For the time being, we need to know two things:</p>
<ul>
<li>The <code>itab</code> and <code>data</code> pointers make up an interface</li>
<li>Different instances of the same concrete interface implementation will recycle the same <code>itab</code></li>
</ul>
<h3 id="interfaces-at-runtime">Interfaces at Runtime</h3>
<p>At runtime, interfaces aren&rsquo;t passed as the single <code>iface</code> struct we saw defined in <code>runtime2.go</code>.
Instead, they&rsquo;re passed as the contents: the <code>itab</code>, <code>data</code> tuple.
We can demonstrate this with the below trivial example: a 2 frame stack, where the caller places a single interface as a parameter to the callee.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;context&#34;</span>

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#a6e22e">panicker</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">WithValue</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>(), <span style="color:#e6db74">&#34;key&#34;</span>, <span style="color:#e6db74">&#34;oops!&#34;</span>))
}

<span style="color:#75715e">//go:noinline
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">panicker</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>) {
	panic(<span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">Value</span>(<span style="color:#e6db74">&#34;key&#34;</span>))
}
</code></pre></div><p>In the resulting output stacktrace, the callee shows two parameters:</p>
<pre><code>panic: oops!

goroutine 1 [running]:
main.panicker(0x1099b60, 0xc000068060)
        /Users/aidan/go/src/github.com/raidancampbell.github.io.source/content/scratch/abusing-context-part-ii.go:11 +0x61
main.main()
        /Users/aidan/go/src/github.com/raidancampbell.github.io.source/content/scratch/abusing-context-part-ii.go:6 +0x7a
</code></pre><p>The bottom of the stack (using the &ldquo;stack grows downwards&rdquo; terminology, whereas the stacktrace shows current execution at the top) has the two values in question: <code>main.panicker(0x1099b60, 0xc000068060)</code>.
While only one was actually passed to the function, two appeared in the call stack.
Why? I&rsquo;m not sure why Go does it this way.
My guess is that the majority of the <code>itab</code> is constructed at compile (linking) time, and is required for the way interfaces are treated in go.
This theory is reinforced by the memory address offset: the <code>itab</code> appears much earlier in memory compared to the data.</p>
<h3 id="rebuilding-an-interface">Rebuilding an interface</h3>
<p>Let&rsquo;s modify the above example to gain access to the stack as a string:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;bufio&#34;</span>
	<span style="color:#e6db74">&#34;bytes&#34;</span>
	<span style="color:#e6db74">&#34;context&#34;</span>
	<span style="color:#e6db74">&#34;fmt&#34;</span>
	<span style="color:#e6db74">&#34;runtime&#34;</span>
)

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#a6e22e">panicker</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">WithValue</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>(), <span style="color:#e6db74">&#34;key&#34;</span>, <span style="color:#e6db74">&#34;oops!&#34;</span>))
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">panicker</span>(<span style="color:#a6e22e">_</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>) {
	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">buf</span> [<span style="color:#ae81ff">8192</span>]<span style="color:#66d9ef">byte</span>
	<span style="color:#a6e22e">n</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">runtime</span>.<span style="color:#a6e22e">Stack</span>(<span style="color:#a6e22e">buf</span>[:], <span style="color:#66d9ef">false</span>) <span style="color:#75715e">// get the current callstack as a string
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">sc</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">bufio</span>.<span style="color:#a6e22e">NewScanner</span>(<span style="color:#a6e22e">bytes</span>.<span style="color:#a6e22e">NewReader</span>(<span style="color:#a6e22e">buf</span>[:<span style="color:#a6e22e">n</span>]))
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">sc</span>.<span style="color:#a6e22e">Scan</span>() {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">sc</span>.<span style="color:#a6e22e">Text</span>())
	}
}
</code></pre></div><p>Minus the panic&rsquo;s message, the results remain the same:</p>
<pre><code>goroutine 1 [running]:
main.panicker(0x10ee820, 0xc000090180)
        /Users/aidan/go/src/github.com/raidancampbell.github.io.source/content/scratch/abusing-context-part-ii.go:17 +0x69
main.main()
        /Users/aidan/go/src/github.com/raidancampbell.github.io.source/content/scratch/abusing-context-part-ii.go:12 +0x7a
</code></pre><p>We know <code>0x10ee820</code> and <code>0xc000090180</code> compose the input context for <code>panicker</code>.
Using the <a href="https://golang.org/pkg/unsafe/"><code>unsafe</code> package</a> we can rebuild the incoming context:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;bufio&#34;</span>
	<span style="color:#e6db74">&#34;bytes&#34;</span>
	<span style="color:#e6db74">&#34;context&#34;</span>
	<span style="color:#e6db74">&#34;fmt&#34;</span>
	<span style="color:#e6db74">&#34;regexp&#34;</span>
	<span style="color:#e6db74">&#34;runtime&#34;</span>
	<span style="color:#e6db74">&#34;unsafe&#34;</span>
)

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#a6e22e">panicker</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">WithValue</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>(), <span style="color:#e6db74">&#34;key&#34;</span>, <span style="color:#e6db74">&#34;oops!&#34;</span>))
}

<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">twoParamPatt</span> = <span style="color:#a6e22e">regexp</span>.<span style="color:#a6e22e">MustCompile</span>(<span style="color:#e6db74">`^.+[a-zA-Z][a-zA-Z0-9\-_]*\.[a-zA-Z][a-zA-Z0-9\-_]*\((?P&lt;type_itab&gt;0x[0-9a-f]+), (?P&lt;type_data&gt;0x[0-9a-f]+).+`</span>)

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">panicker</span>(<span style="color:#a6e22e">_</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>) {
	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">buf</span> [<span style="color:#ae81ff">8192</span>]<span style="color:#66d9ef">byte</span>
	<span style="color:#a6e22e">n</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">runtime</span>.<span style="color:#a6e22e">Stack</span>(<span style="color:#a6e22e">buf</span>[:], <span style="color:#66d9ef">false</span>) <span style="color:#75715e">// get the current callstack as a string
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">sc</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">bufio</span>.<span style="color:#a6e22e">NewScanner</span>(<span style="color:#a6e22e">bytes</span>.<span style="color:#a6e22e">NewReader</span>(<span style="color:#a6e22e">buf</span>[:<span style="color:#a6e22e">n</span>]))
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">sc</span>.<span style="color:#a6e22e">Scan</span>() {
		<span style="color:#75715e">// match the expected regex.  for this example, we&#39;re only expecting the below match (addrs will vary):
</span><span style="color:#75715e"></span>		<span style="color:#75715e">// main.panicker(0x10ee820, 0xc000090180)
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">matches</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">twoParamPatt</span>.<span style="color:#a6e22e">FindStringSubmatch</span>(<span style="color:#a6e22e">sc</span>.<span style="color:#a6e22e">Text</span>())
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">matches</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#66d9ef">continue</span>
		}

		<span style="color:#75715e">// grab the two memory addresses (itab and data value)
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">p1</span>, <span style="color:#a6e22e">p2</span> <span style="color:#66d9ef">uintptr</span>
		<span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err1</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sscanf</span>(<span style="color:#a6e22e">matches</span>[<span style="color:#ae81ff">1</span>], <span style="color:#e6db74">&#34;%v&#34;</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">p1</span>)
		<span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err2</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sscanf</span>(<span style="color:#a6e22e">matches</span>[<span style="color:#ae81ff">2</span>], <span style="color:#e6db74">&#34;%v&#34;</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">p2</span>)
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err1</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">err2</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#66d9ef">continue</span>
		}

		<span style="color:#75715e">// put the two pointers into the iface layout
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">idata</span> <span style="color:#f92672">:=</span> [<span style="color:#ae81ff">2</span>]<span style="color:#66d9ef">uintptr</span>{<span style="color:#a6e22e">p1</span>, <span style="color:#a6e22e">p2</span>}

		<span style="color:#75715e">// declare that the iface is a context
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">ctx</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">*</span>(<span style="color:#f92672">*</span><span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>)(<span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">idata</span>))
		
		<span style="color:#75715e">// use the context
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">Value</span>(<span style="color:#e6db74">&#34;key&#34;</span>))
	}
}
</code></pre></div><p>Walking through the above code:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">twoParamPatt</span> = <span style="color:#a6e22e">regexp</span>.<span style="color:#a6e22e">MustCompile</span>(<span style="color:#e6db74">`^.+[a-zA-Z][a-zA-Z0-9\-_]*\.[a-zA-Z][a-zA-Z0-9\-_]*\((?P&lt;type_itab&gt;0x[0-9a-f]+), (?P&lt;type_data&gt;0x[0-9a-f]+).+`</span>)
</code></pre></div><p>A rather nasty regex for matching the &ldquo;<!-- raw HTML omitted -->.<!-- raw HTML omitted -->(arg1, arg2&rdquo; part of a stacktrace.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">p1</span>, <span style="color:#a6e22e">p2</span> <span style="color:#66d9ef">uintptr</span>
<span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err1</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sscanf</span>(<span style="color:#a6e22e">matches</span>[<span style="color:#ae81ff">1</span>], <span style="color:#e6db74">&#34;%v&#34;</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">p1</span>)
<span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err2</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sscanf</span>(<span style="color:#a6e22e">matches</span>[<span style="color:#ae81ff">2</span>], <span style="color:#e6db74">&#34;%v&#34;</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">p2</span>)
<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err1</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">err2</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
    <span style="color:#66d9ef">continue</span>
}
</code></pre></div><p>Extracting the string hex addresses into actual <code>uintptr</code>.  In the above execution, these would be <code>0x10ee820</code> and <code>0xc000090180</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#a6e22e">idata</span> <span style="color:#f92672">:=</span> [<span style="color:#ae81ff">2</span>]<span style="color:#66d9ef">uintptr</span>{<span style="color:#a6e22e">p1</span>, <span style="color:#a6e22e">p2</span>}
</code></pre></div><p>This is placing two pointers in the same layout as the <code>iface</code> struct: <code>itab</code> pointer first, data pointer second.
Remember that the internal struct for an interface looks like this:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">iface</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">tab</span>  <span style="color:#f92672">*</span><span style="color:#a6e22e">itab</span>
	<span style="color:#a6e22e">data</span> <span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span>
}
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#a6e22e">ctx</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">*</span>(<span style="color:#f92672">*</span><span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>)(<span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">idata</span>))
</code></pre></div><p>Create an unsafe pointer to the effective <code>iface</code> struct instance, then cast that pointer as a <code>context.Context</code> pointer, then dereference the <code>context.Context</code> pointer for your final value.
At this point we&rsquo;ve &ldquo;recovered&rdquo; the context, but it&rsquo;s a bit moot since we were given the context to begin with.
How would we handle true context recovery if it existed somewhere up the stack, but was never passed to us?</p>
<h3 id="context-recovery-through-dynamic-scoping">Context recovery through dynamic scoping</h3>
<p>The above code has a major fatal flaw: it finds the first function up the stack with two parameters, and blindly jams them into a <code>context.Context</code>.
In reality we don&rsquo;t know if the first two parameters are the <code>itab</code> and data pointers: they may be ints, or even an <code>itab</code> and data pointer for an unrelated interface.</p>
<p>Here we call upon our initial restrictions: <code>context.Context</code> should always be first, and we know the four possible implementations of context.
Knowing that there&rsquo;s four possible implementations allows us to enumerate the legal itab pointers on invocation:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">RecoverCtx</span>() (<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#66d9ef">error</span>) {
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">emptyItab</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>())
}

<span style="color:#75715e">//go:noinline
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">emptyItab</span>(<span style="color:#a6e22e">_</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>) (<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#66d9ef">error</span>) {
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">valueItab</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">WithValue</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>(), <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#e6db74">&#34;&#34;</span>))
}

<span style="color:#75715e">//go:noinline
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">valueItab</span>(<span style="color:#a6e22e">_</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>) (<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#66d9ef">error</span>) {
	<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">c</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">WithCancel</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>())
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">c</span>()
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">cancelItab</span>(<span style="color:#a6e22e">ctx</span>)
}

<span style="color:#75715e">//go:noinline
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">cancelItab</span>(<span style="color:#a6e22e">_</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>) (<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#66d9ef">error</span>) {
	<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">c</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">WithDeadline</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>(), <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>())
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">c</span>()
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">timerItab</span>(<span style="color:#a6e22e">ctx</span>)
}

<span style="color:#75715e">//go:noinline
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">timerItab</span>(<span style="color:#a6e22e">_</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>) (<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#66d9ef">error</span>) {
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">doGetCtx</span>()
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">doGetCtx</span>() (<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#66d9ef">error</span>) {
    <span style="color:#75715e">// TODO
</span><span style="color:#75715e"></span>}
</code></pre></div><p>The above outlines a call chain: the entry point is the exported <code>RecoverCtx</code> function, which passes through several other functions on its way down to the actual implementation.
Each of these functions receives a context, then passes it to the next function.
When viewing the stack at runtime, it would look like this:</p>
<pre><code>libraidan/pkg/runsafe.doGetCtx(0x0, 0x0, 0x0, 0x0)
	/Users/aidan/go/src/libraidan/pkg/runsafe/context.go:59 +0xbb
libraidan/pkg/runsafe.timerItab(0x14b5ce0, 0xc0000a44e0, 0x0, 0x0, 0x0, 0x0)
	/Users/aidan/go/src/libraidan/pkg/runsafe/context.go:52 +0x4c
libraidan/pkg/runsafe.cancelItab(0x14b5c60, 0xc0000e8c40, 0x0, 0x0, 0x0, 0x0)
	/Users/aidan/go/src/libraidan/pkg/runsafe/context.go:47 +0x1a5
libraidan/pkg/runsafe.valueItab(0x14b5d20, 0xc00009d320, 0x0, 0x0, 0x0, 0x0)
	/Users/aidan/go/src/libraidan/pkg/runsafe/context.go:40 +0x150
libraidan/pkg/runsafe.emptyItab(0x14b5ca0, 0xc0000a6008, 0x0, 0x0, 0x0, 0x0)
	/Users/aidan/go/src/libraidan/pkg/runsafe/context.go:33 +0xd7
libraidan/pkg/runsafe.RecoverCtx(0x0, 0x0, 0x0, 0x0)
</code></pre><p>Using this stack, we can build guarantees:</p>
<ul>
<li>we know how many functions live above our call to <code>runtime.Stack</code></li>
<li>we know the name of each of these functions</li>
<li>we know the concrete input type (effectively the <code>itab</code>) each function receives</li>
</ul>
<p>Why all the <code>//go:noinline</code> pragmas? The compiler would inline the trivial functions, and we&rsquo;d lose the parameter addresses.
The same stack, but without inlining disabled:</p>
<pre><code>libraidan/pkg/runsafe.doGetCtx(0x13a1520, 0xc0000a6008, 0xbfae3de322870128, 0xbc60e)
	/Users/aidan/go/src/libraidan/pkg/runsafe/context.go:59 +0x5b
libraidan/pkg/runsafe.timerItab(...)
	/Users/aidan/go/src/libraidan/pkg/runsafe/context.go:52
libraidan/pkg/runsafe.cancelItab(0x13a14e0, 0xc0000e09c0, 0x0, 0x0, 0x0, 0x0)
	/Users/aidan/go/src/libraidan/pkg/runsafe/context.go:47 +0x9e
libraidan/pkg/runsafe.valueItab(0x13a15a0, 0xc00009d320, 0x0, 0x0, 0x0, 0x0)
	/Users/aidan/go/src/libraidan/pkg/runsafe/context.go:40 +0x82
libraidan/pkg/runsafe.emptyItab(0x13a1520, 0xc0000a6008, 0xc000040680, 0x100e808, 0x30, 0x130a680)
	/Users/aidan/go/src/libraidan/pkg/runsafe/context.go:33 +0x7e
libraidan/pkg/runsafe.RecoverCtx(...)
</code></pre><p>With the parameters elided, we lose the <code>itab</code> pointers and can&rsquo;t enumerate the legal values.
In this scenario, we would be missing out on recovering certain context implementations.</p>
<p>With all the above in mind, we&rsquo;re finally ready to implement the <code>doGetCtx()</code> function:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">doGetCtx</span>() (<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#66d9ef">error</span>) {
	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">buf</span> [<span style="color:#ae81ff">8192</span>]<span style="color:#66d9ef">byte</span>
	<span style="color:#a6e22e">n</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">runtime</span>.<span style="color:#a6e22e">Stack</span>(<span style="color:#a6e22e">buf</span>[:], <span style="color:#66d9ef">false</span>) <span style="color:#75715e">// get the current callstack as a string
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">sc</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">bufio</span>.<span style="color:#a6e22e">NewScanner</span>(<span style="color:#a6e22e">bytes</span>.<span style="color:#a6e22e">NewReader</span>(<span style="color:#a6e22e">buf</span>[:<span style="color:#a6e22e">n</span>]))
	<span style="color:#66d9ef">var</span> (
        <span style="color:#75715e">// hold the type itab pointers for each of the context implementations
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">deadlineType</span>, <span style="color:#a6e22e">cancelType</span>, <span style="color:#a6e22e">valueType</span>, <span style="color:#a6e22e">emptyType</span> <span style="color:#66d9ef">uintptr</span> 
         <span style="color:#75715e">// used to count our way up the stack, 
</span><span style="color:#75715e"></span>         <span style="color:#75715e">// as the stack is constant the lowest few levels and we need to leverage that
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">stackMatch</span> <span style="color:#66d9ef">int</span>    
	)
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">sc</span>.<span style="color:#a6e22e">Scan</span>() { <span style="color:#75715e">// for each line (walking up the stack from here)
</span><span style="color:#75715e"></span>		<span style="color:#75715e">// if the line doesn&#39;t match, skip.
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">matches</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">pattern</span>.<span style="color:#a6e22e">FindStringSubmatch</span>(<span style="color:#a6e22e">sc</span>.<span style="color:#a6e22e">Text</span>())
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">matches</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#66d9ef">continue</span>
		}
		<span style="color:#75715e">// if this is the first iteration, then it&#39;s just our function. skip it.
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">stackMatch</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">strings</span>.<span style="color:#a6e22e">Contains</span>(<span style="color:#a6e22e">sc</span>.<span style="color:#a6e22e">Text</span>(), <span style="color:#e6db74">&#34;doGetCtx&#34;</span>) {
			<span style="color:#66d9ef">continue</span>
		}

		<span style="color:#a6e22e">stackMatch</span><span style="color:#f92672">++</span>

		<span style="color:#75715e">// grab the two memory addresses (itab and type value)
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">p1</span>, <span style="color:#a6e22e">p2</span> <span style="color:#66d9ef">uintptr</span>
		<span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err1</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sscanf</span>(<span style="color:#a6e22e">matches</span>[<span style="color:#ae81ff">1</span>], <span style="color:#e6db74">&#34;%v&#34;</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">p1</span>)
		<span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err2</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sscanf</span>(<span style="color:#a6e22e">matches</span>[<span style="color:#ae81ff">2</span>], <span style="color:#e6db74">&#34;%v&#34;</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">p2</span>)
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err1</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">err2</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#66d9ef">continue</span>
		}

		<span style="color:#75715e">// build up the legal values for each implementation of context
</span><span style="color:#75715e"></span>		<span style="color:#75715e">// the stackMatch must match the known location in the stack.
</span><span style="color:#75715e"></span>		<span style="color:#75715e">// Otherwise we might return a malformed context
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">stackMatch</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">strings</span>.<span style="color:#a6e22e">Contains</span>(<span style="color:#a6e22e">sc</span>.<span style="color:#a6e22e">Text</span>(), <span style="color:#e6db74">&#34;timerItab&#34;</span>) {
			<span style="color:#a6e22e">deadlineType</span> = <span style="color:#a6e22e">p1</span>
		} <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">stackMatch</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">strings</span>.<span style="color:#a6e22e">Contains</span>(<span style="color:#a6e22e">sc</span>.<span style="color:#a6e22e">Text</span>(), <span style="color:#e6db74">&#34;cancelItab&#34;</span>) {
			<span style="color:#a6e22e">cancelType</span> = <span style="color:#a6e22e">p1</span>
		} <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">stackMatch</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">3</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">strings</span>.<span style="color:#a6e22e">Contains</span>(<span style="color:#a6e22e">sc</span>.<span style="color:#a6e22e">Text</span>(), <span style="color:#e6db74">&#34;valueItab&#34;</span>) {
			<span style="color:#a6e22e">valueType</span> = <span style="color:#a6e22e">p1</span>
		} <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">stackMatch</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">4</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">strings</span>.<span style="color:#a6e22e">Contains</span>(<span style="color:#a6e22e">sc</span>.<span style="color:#a6e22e">Text</span>(), <span style="color:#e6db74">&#34;emptyItab&#34;</span>) {
			<span style="color:#a6e22e">emptyType</span> = <span style="color:#a6e22e">p1</span>
		} <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">p1</span> <span style="color:#f92672">!=</span> <span style="color:#a6e22e">emptyType</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">p1</span> <span style="color:#f92672">!=</span> <span style="color:#a6e22e">valueType</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">p1</span> <span style="color:#f92672">!=</span> <span style="color:#a6e22e">cancelType</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">p1</span> <span style="color:#f92672">!=</span> <span style="color:#a6e22e">deadlineType</span> {
			<span style="color:#75715e">// if we&#39;re in the caller&#39;s code, and the first parameter isn&#39;t a 
</span><span style="color:#75715e"></span>			<span style="color:#75715e">// known context implementation, then skip this stack frame
</span><span style="color:#75715e"></span>			<span style="color:#66d9ef">continue</span>
		}

		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">stackMatch</span> <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">4</span> { <span style="color:#75715e">// we&#39;re still building the legal context implementations
</span><span style="color:#75715e"></span>			<span style="color:#66d9ef">continue</span>
		}

		<span style="color:#75715e">// at this point we&#39;re done building the legal context implementations, 
</span><span style="color:#75715e"></span>		<span style="color:#75715e">// and this matched one. rebuild a context from the addresses, and return
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">idata</span> <span style="color:#f92672">:=</span> [<span style="color:#ae81ff">2</span>]<span style="color:#66d9ef">uintptr</span>{<span style="color:#a6e22e">p1</span>, <span style="color:#a6e22e">p2</span>}
		<span style="color:#66d9ef">return</span> <span style="color:#f92672">*</span>(<span style="color:#f92672">*</span><span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>)(<span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">idata</span>)), <span style="color:#66d9ef">nil</span>
	}
	<span style="color:#75715e">// no context was found.  Return a non-nil context to be polite, but also return an error.
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>(), <span style="color:#a6e22e">UnrecoverableContext</span>{}
}
</code></pre></div><p>We leverage the known frames as we move up the callstack from <code>doGetCtx</code> to <code>RecoverCtx</code>.
Each of these frames is verified by name and location, then the <code>itab</code> pointer value is stored.
Once the we&rsquo;ve left the comfort of our guaranteed callstack, we need to match the first address against one of the known <code>itab</code> values.
If one is found, then the resulting context is built and returned.
But there&rsquo;s no guarantee this will happen: the context could be elided due to inlining in the caller&rsquo;s code, or the caller could have never had a context to begin with!</p>
<p>The full code, which I do not recommend using, is available in libraidan&rsquo;s <a href="https://github.com/raidancampbell/libraidan/blob/master/pkg/runsafe/context.go#L23">runsafe package</a>.</p>


        

        

        
      </article>

      
        <ul class="pager blog-pager">
          
            <li class="previous">
              <a href="https://raidancampbell.com/posts/abusing-context-part-i/" data-toggle="tooltip" data-placement="top" title="Abusing Context in Go Part I: Serialization">&larr; Previous Post</a>
            </li>
          
          
        </ul>
      


      

    </div>
  </div>
</div>

      
<footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center footer-links">
          
              <li>
                <a href="https://github.com/raidancampbell" title="GitHub">
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fab fa-github fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a href="https://twitter.com/@raidancampbell" title="Twitter">
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fab fa-twitter fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a href="https://linkedin.com/in/r-aidan-campbell-73436a31" title="LinkedIn">
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fab fa-linkedin fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
          
        </ul>
        <p class="credits copyright text-muted">
          
            
              <a href="raidancampbell.com">R. Aidan Campbell</a>
            
          

          &nbsp;&bull;&nbsp;&copy;
          
            2020
          

          
            &nbsp;&bull;&nbsp;
            <a href="https://raidancampbell.com/">raidancampbell</a>
          
        </p>
        
        <p class="credits theme-by text-muted">
          <a href="https://gohugo.io">Hugo v0.71.0</a> powered &nbsp;&bull;&nbsp; Theme <a href="https://github.com/halogenica/beautifulhugo">Beautiful Hugo</a> adapted from <a href="https://deanattali.com/beautiful-jekyll/">Beautiful Jekyll</a>
          
        </p>
      </div>
    </div>
  </div>
</footer><script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.js" integrity="sha384-K3vbOmF2BtaVai+Qk37uypf7VrgBubhQreNQe9aGsz9lB63dIFiQVlJbr92dw2Lx" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/contrib/auto-render.min.js" integrity="sha384-kmZOZB5ObwgQnS/DuDg6TScgOiWWBiVt0plIRkZCmE6rDZGrEOQeHM5PcHi+nyqe" crossorigin="anonymous"></script>
<script src="https://code.jquery.com/jquery-1.12.4.min.js" integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

<script src="https://raidancampbell.com/js/main.js"></script><script> renderMathInElement(document.body); </script><script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.js" integrity="sha384-QELNnmcmU8IR9ZAykt67vGr9/rZJdHbiWi64V88fCPaOohUlHCqUD/unNN0BXSqy" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe-ui-default.min.js" integrity="sha384-m67o7SkQ1ALzKZIFh4CiTA8tmadaujiTa9Vu+nqPSwDOqHrDmxLezTdFln8077+q" crossorigin="anonymous"></script><script src="https://raidancampbell.com/js/load-photoswipe.js"></script>









    
  </body>
</html>

